# 【21】資安的原罪 ch.3-3.c 防火牆與防毒軟體
## 防火牆
防火牆是降低複雜度的例子
只要在入口處保護
沒有其他出入口
隊友著幾百幾天台電腦的組織，這是一個方案

黑名單
白名單
### **1. Firewall:**

A **firewall** is a security system designed to monitor and control incoming and outgoing network traffic. Its purpose is to protect your devices (computers, smartphones, etc.) or networks from unauthorized access and malicious activity.

#### **Main Concepts of Firewalls:**

* **Types of Firewalls:**

  * **Hardware Firewalls**: Physical devices placed between a network and the internet, used to filter traffic and block malicious data.
  * **Software Firewalls**: Installed on individual computers or devices, these firewalls act as a barrier between the device and the internet to control traffic.
  * **Cloud Firewalls**: These firewalls protect cloud-based services and data and are generally more scalable for large networks.
## 代理防火牆 proxy firewall
應用曾防火牆
網路連結的中間人，在內網與網際網路之間，在保護之裝置的另一側重新創造出網路連結
TODO: DECSEAL
### **Proxy Firewall (also called Application-Level Gateway)**

A **proxy firewall** is a type of firewall that works by acting as an intermediary between a user (or device) and the internet. Instead of directly forwarding requests to the destination, it **proxies** or **relays** the requests on behalf of the user. This provides an additional layer of security by filtering requests at the **application layer**.

#### **How It Works:**

* **Requests are intercepted**: When a user or device wants to access the internet, it sends a request to the proxy firewall instead of the destination server directly.
* **Traffic is inspected**: The proxy firewall examines the request (and sometimes the content) to ensure it adheres to security policies.
* **Request is forwarded**: If the request is allowed, the proxy firewall makes the actual request to the destination server on behalf of the user. The server sends the response back to the proxy firewall, which then forwards it to the user.
* **No direct connection**: The user’s device does not have a direct connection to the destination server; the communication occurs through the proxy firewall, which hides the user's identity and internal network structure.

---

#### **Main Concepts of Proxy Firewalls:**

1. **Application Layer Filtering**:

   * Unlike traditional firewalls that typically operate at the network layer (IP, TCP/UDP), **proxy firewalls** work at the application layer (HTTP, FTP, etc.). This means they can inspect the actual data being exchanged (e.g., web requests, email content) rather than just looking at the headers or metadata.

2. **Better Control over Traffic**:

   * Because proxy firewalls can inspect the contents of traffic at a deeper level, they offer greater **granularity** in controlling and filtering applications. For example, they can block specific web pages, restrict the use of certain services (like chat or video streaming), or prevent file downloads that match known patterns of malware.

3. **Anonymity and Privacy**:

   * Proxy firewalls can **mask the user's IP address** from the outside world. This is useful for security and privacy, as external servers cannot directly see the user’s real IP address.
   * This is particularly useful in **secure browsing** scenarios where you want to hide your identity or prevent tracking.

4. **Isolation**:

   * Because the proxy firewall sits between the internal network and the external world, it **isolates the internal network** from direct exposure to the internet. This prevents direct communication between the client and the server, providing an extra layer of protection.

---

#### **Types of Proxy Firewalls:**

1. **Forward Proxy**:
   * The most common form of proxy firewall. It acts on behalf of the client or internal network and forwards requests to the destination on their behalf. It can cache content to improve performance and block access to malicious sites.

2. **Reverse Proxy**:
   * A reverse proxy acts on behalf of a server or web service. Instead of handling requests from internal users, it handles requests coming from external users and forwards them to the appropriate internal server. This type of proxy can provide load balancing, web acceleration, and security features like hiding the internal server structure.


* **Traffic Filtering:**

  * Firewalls use a set of rules to determine whether data should be allowed to enter or leave the network. This could be based on:

    * **IP addresses**
    * **Ports**
    * **Protocols** (e.g., HTTP, FTP)
    * **Content** (to filter based on keywords or known threats)

* **Stateful vs. Stateless:**

  * **Stateful** firewalls track the state of active connections, meaning they can differentiate between valid responses to requests and unsolicited traffic.
  * **Stateless** firewalls, on the other hand, don't track the state of the connections, they simply allow or block data packets based on predefined rules.

* **Intrusion Prevention and Detection:**
  Some firewalls come with additional features that detect suspicious activity or block attempts to breach the network (e.g., Distributed Denial of Service (DDoS) attacks).



---

## 原罪

## **Main Concepts of Anti-Virus:**
模式匹配 檢查目標檔案是否根事先登錄的惡以軟體

行為偵測 機器學習 根據軟體通常會有的行為模式來判斷是不是惡意軟體
自我繁殖 擅自移除 編輯電腦內其他檔案
* **Malware Detection:**

  * **Signature-based Detection**: The software uses a database of known malware signatures (unique patterns of data) to identify viruses. This is effective for known threats but doesn’t catch new, unknown malware.
  * **Heuristic-based Detection**: Anti-virus programs use heuristics (rule-based systems) to identify potentially harmful behavior or code patterns, even if the exact malware hasn’t been seen before.
  * **Behavioral-based Detection**: Looks for unusual or suspicious activities (like a program trying to access large portions of memory or send data over the network) to identify malware in real-time.

* **Types of Malware:**

  * **Viruses**: Code that attaches itself to a legitimate program or file and spreads when that file is opened.
  * **Trojans**: Malware that masquerades as legitimate software to trick users into installing it.
  * **Worms**: Self-replicating programs that spread without any user interaction, often through network vulnerabilities.
  * **Spyware/Adware**: Software that tracks user behavior or displays unwanted ads.

* **Scanning and Quarantine:**
  Anti-virus software scans files, applications, and downloads for suspicious activity. If it finds malware, it can:

  * **Quarantine** the file (isolating it from the rest of the system)
  * **Delete** the malware
  * **Repair** the file, if possible

* **Real-time Protection:**
  Most modern anti-virus software runs in the background, continuously scanning new files or actions on your device to prevent malware infections before they happen.

---

---

### **1. Sandbox (in Anti-Virus Context)**
動態啟發是掃描
A **sandbox** is a **security mechanism** used to isolate and test suspicious files, programs, or behaviors in a controlled environment to prevent them from causing harm to the rest of the system. In the context of **anti-virus**, sandboxing is used to execute files or software in a secure, isolated space (a "sandbox") where they cannot affect the actual system or network.

   * **Incorporate in Detection Mechanisms**: Sandboxing is often used as part of anti-virus software to **analyze files** in a controlled environment. It's not always a standalone feature but rather an advanced technique for **real-time malware analysis**. You could place sandboxing under the "Malware Detection" or "Advanced Detection Methods" section in anti-virus.

#### **How Sandboxing Works:**

* **Isolation**: Suspicious files (e.g., newly downloaded software, email attachments, or unknown executables) are executed in a virtual environment.
* **Behavior Monitoring**: The sandbox monitors how the file behaves. Does it try to modify system files, send data to external servers, or access other applications? Any malicious activity can be flagged immediately.
* **No Harm to the Host System**: Since the file is running in a contained environment, if it's malicious, it can’t harm the device. If the file is benign, it can be allowed to run on the main system after passing the test.

#### **Benefits in Anti-Virus:**

* **Detection of Unknown Malware**: Sandboxing helps detect malware that doesn't have known signatures (i.e., zero-day threats). Even if the anti-virus software doesn't recognize the file, the sandbox can detect malicious behavior.
* **Safe Testing of Files**: Suspicious files can be safely analyzed without risking the device's integrity.

1. **Sandboxing with Virtual Machines**:

   * "Modern sandboxes often use **virtual machines (VMs)** to simulate an isolated environment. VMs allow security systems to run potentially harmful software in a controlled, virtualized environment, where its behavior can be monitored and analyzed without risking the host system."

2. **Isolation and Monitoring**:

   * "VMs play a key role in sandboxing by ensuring that malware cannot escape into the host operating system. The virtualized environment is isolated from the real system, and if anything goes wrong, the snapshot feature of the VM allows for **easy restoration** to a clean state."

3. **VM Evasion**:

   * "However, while VMs provide excellent isolation, some sophisticated malware is designed to **detect virtual environments** and avoid executing harmful actions when it detects that it’s running inside a VM. This presents a challenge for traditional sandboxing techniques that rely on VM-based isolation."

4. **Advancements in Virtual Machine Sandbox Solutions**:

   * "To combat evasion techniques, modern sandboxing solutions are incorporating advanced **hypervisor-level** isolation, which offers additional protection and makes it more difficult for malware to escape the sandboxed environment."

---

### **2. Honeypot (in Anti-Virus Context)**

A **honeypot** is a **decoy system** or network designed to attract and monitor cyberattacks. It is set up to simulate a vulnerable target that attackers might try to exploit, so defenders can observe their tactics, techniques, and procedures (TTPs). Honeypots are often used in more advanced security setups to gather intelligence and study attack patterns, but they can also play a role in anti-virus and broader malware detection strategies.

* **As a Complementary Technology**: Honeypots are not typically directly integrated into anti-virus software but can be part of a broader **network defense strategy**. If you want to include honeypots in the anti-virus section, you could mention them as a **complementary tool** that provides early detection and intelligence for improving malware databases. It would fit under something like **Threat Intelligence** or **Behavioral Analysis**.
#### **How Honeypots Work:**

* **Luring Attackers**: Honeypots appear to be weak, vulnerable systems (like outdated software, exposed ports, etc.) designed to attract cybercriminals. Once attackers engage with the honeypot, it records their activities.
* **Data Collection**: The honeypot collects valuable data, such as IP addresses of attackers, methods they use to exploit vulnerabilities, and the types of malware they attempt to deploy.
* **Preventing Spread**: While the attackers are focused on the decoy system, it helps prevent them from targeting real, critical assets in the network.

#### **Benefits in Anti-Virus:**

* **Threat Intelligence**: The data collected from honeypots can help improve anti-virus detection capabilities by providing insight into new attack methods, malware variants, or emerging threats that were not previously on the radar.
* **Early Warning**: Honeypots can act as an early-warning system, identifying threats before they fully manifest on a network or device.
 

---

## SIN

### 防火牆
 安全模型從主機推動到邊界
有些組織僅在入口
端點電腦防護幾乎0

防火牆允與許的流量 可以含攻擊
向全球自訊網基本允許，但網頁伺服器基本上都會有弱點
畢竟 通常允許全球資訊網的流量 而這些流量中就可能存在著攻擊

### 防毒
新弱點病毒 才更新特徵值 而不是解決弱點

防毒 使 惡意軟體演化得更為精巧

模式匹配  千面人引勤 變種找步道

行為偵測 偵測不到 什麼叫怪異行為? 

大量偽陽性 導致使用者習慣略
而且真正有問題的反而沒有任何警示

### 沙河
sandbox 跳出
### **How Malware Can Escape a Sandbox:**

1. **Exploiting Vulnerabilities in the Sandbox**:

   * Just like any software, sandbox environments can have **security vulnerabilities**. These weaknesses might be exploited by malware to gain access to the underlying host system.

   * For example, if a sandbox uses certain **shared resources** or is based on an OS or virtualization platform with known vulnerabilities, the malware could **exploit those vulnerabilities** to escape the isolated environment.

   * **Example**: A sandbox might rely on virtualization software (like VMware or VirtualBox), which could have a vulnerability that allows the malware to **break out** from the virtual machine and execute commands on the host system.

2. **Manipulating Shared Resources**:

   * Sandboxes typically simulate an environment with shared resources like disk space, memory, or networking. Malware can sometimes find a way to manipulate these shared resources to escape the sandbox and spread to the host system.
   * **Example**: Malware might find ways to exploit **shared file systems** or **network interfaces** that the sandbox is using to communicate with the host system. By exploiting these shared interfaces, it can push malicious payloads outside the sandbox to the actual system.

3. **Leveraging Kernel Exploits**:

   * In some cases, advanced malware might attempt to break free from a sandbox by exploiting vulnerabilities in the **kernel** of the operating system that is hosting the virtual machine or sandbox. This is a **privilege escalation** attack where the malware moves from the isolated user space into the core part of the OS.
   * **Example**: The malware could attempt to manipulate the sandbox’s **privileged kernel mode** to gain access to the host machine’s kernel and execute commands outside the sandbox.

4. **Direct Memory Access (DMA) Attacks**:

   * In certain configurations, especially in virtual environments, malware might be able to use **DMA** (Direct Memory Access) to **access the physical memory** of the host system. This could allow the malware to bypass the sandbox’s controls and **execute on the host machine**.
   * **Example**: Some malware can try to interact with the **hardware layer** to access memory regions that are shared between the sandbox and the host OS, enabling it to escape the virtualized isolation.

5. **Hypervisor/Virtual Machine Escape**:

   * A **hypervisor** is responsible for managing virtual machines (VMs) in sandbox environments. Some sophisticated malware can target vulnerabilities in the hypervisor itself. If successful, this type of attack can allow malware to **escape the virtual machine** and gain control of the host system.
   * **Example**: If the hypervisor isn’t properly secured, the malware could exploit a flaw to break out of the virtual environment, making it possible to affect not just the sandbox but also the actual system hosting it.

6. **Infecting Other VMs in a Multi-VM Setup**:

   * If a **sandboxing system** runs multiple **virtual machines** on a single host (for testing different behaviors or scenarios), malware could potentially spread across VMs if **network isolation** isn’t properly implemented.
   * **Example**: In a situation where multiple VMs are running on a shared system, malware could potentially infect other VMs on the same host if the isolation mechanisms are weak or misconfigured.

---

### **Why It Happens:**

* **Improper Configuration**: Sandboxes often rely on virtual machines or containers to isolate suspicious processes. If these virtual machines or containers are not configured with strong security controls (e.g., network isolation, resource limits), malware may find ways to bypass those defenses.
* **Zero-Day Exploits**: Some malware are designed to **exploit vulnerabilities** in the sandbox itself—vulnerabilities that might not yet have been discovered or patched. These exploits are often **zero-day**, meaning there’s no prior knowledge of the flaw.
* **Advanced Threat Actors**: More sophisticated cybercriminals or **nation-state actors** often design malware with the intention of evading detection, including sandbox evasion. Their malware might be intentionally crafted to **look benign** when in a sandbox but have the capability to **break out** and fully infect the system when it’s on a real, unprotected machine.

---

### **Real-World Examples of Sandbox Escape:**

1. **CVE-2019-5588 (VMware Escape)**:

   * This vulnerability allowed malware to break out of a **VMware** virtual machine by exploiting flaws in the **vmx** process. Malware running in a virtual machine could execute code on the host system, leading to **host system compromise**.
   * This kind of escape technique highlights the risk of running outdated or unpatched virtual environments.

2. **CVE-2018-5803 (Hyper-V Escape)**:

   * In 2018, a vulnerability was discovered in **Microsoft’s Hyper-V hypervisor** that could allow malware running inside a virtual machine to **escape** and run on the underlying host system. This kind of vulnerability would have serious consequences for sandbox systems running on top of Hyper-V.

3. **Poweliks Trojan**:

   * The **Poweliks Trojan** was a particularly stealthy piece of malware that was able to **evade detection** by analyzing the behavior of the system. It could detect whether it was running in a virtualized environment and **avoid executing** if it was running inside a sandbox. However, if it escaped the sandbox, it could proceed to infect the host machine.
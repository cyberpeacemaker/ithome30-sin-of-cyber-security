# 【21】資安的原罪 ch.3-3.c 防火牆與防毒軟體

They complement each other—firewalls protect the network boundaries, while anti-virus protects the system itself from infections.

---

## 防火牆
防火牆是降低複雜度的例子
只要在入口處保護
沒有其他出入口
隊友著幾百幾天台電腦的組織，這是一個方案

黑名單
白名單

## **1. 防火牆（Firewall）：**

**防火牆**是一種用來監控和控制進出網路流量的安全系統。它的目的是保護你的裝置（電腦、智慧型手機等）或網路，防止未經授權的存取和惡意活動。

#### **防火牆的主要概念：**

* **防火牆的類型：**

  * **硬體防火牆**：置於網路與互聯網之間的實體設備，用來過濾流量並阻擋惡意資料。
  * **軟體防火牆**：安裝在個別電腦或裝置上，作為裝置與互聯網之間的屏障來控制流量。
  * **雲端防火牆**：用於保護雲端服務和數據，通常更具擴展性，適合大型網路使用。

* **防火牆政策（Firewall Policy）：**

  防火牆依據一套規則或政策來決定哪些流量可以通過，哪些必須被阻擋。這些規則通常包括：

  * **允許（Allow）或拒絕（Deny）特定的IP地址或網段**。
  * **根據連接埠（Port）或協定（如TCP、UDP）過濾流量**。
  * **根據來源或目的地的地址篩選資料包**。
  * **基於時間設定規則，例如僅在特定時間段允許流量**。

  透過設定合理的政策，防火牆能有效阻止可疑流量，提升整體網路安全。



## 代理防火牆 proxy firewall
應用層防火牆 TODO: DECSEAL
網路連結的中間人，在內網與網際網路之間，在保護之裝置的另一側重新創造出網路連結


### **Proxy Firewall (also called Application-Level Gateway)**

A **proxy firewall** is a type of firewall that works by acting as an intermediary between a user (or device) and the internet. Instead of directly forwarding requests to the destination, it **proxies** or **relays** the requests on behalf of the user. This provides an additional layer of security by filtering requests at the **application layer**.

### 工作原理：

* **攔截請求**
  當使用者或設備想要連接網際網路時，會先將請求送到代理防火牆，而非直接連接到目的伺服器。

* **檢查流量**
  代理防火牆會檢查這些請求（有時甚至會檢查內容），以確保符合安全政策。

* **轉送請求**
  如果請求被允許，代理防火牆會代表使用者向目的伺服器發出真正的請求。伺服器回應後，代理防火牆再將回應轉發給使用者。

* **無直接連線**
  使用者的設備不會與目的伺服器有直接連線，所有通訊都是經由代理防火牆轉送。這樣做可以隱藏使用者的身份及內部網路結構，提升安全性。


#### **代理防火牆的主要概念：**

1. **應用層過濾**：

   * 傳統防火牆通常在網路層（如IP、TCP/UDP）運作，而**代理防火牆**則在應用層（如HTTP、FTP等）工作。這表示代理防火牆能檢查實際交換的數據內容（例如網頁請求、電子郵件內容），而不只是看標頭或元數據。

2. **更細緻的流量控制**：

   * 由於代理防火牆能深入檢查流量內容，因此它提供更高的**粒度**來控制和過濾應用程序。例如，可以阻擋特定網頁、限制某些服務的使用（如聊天或影片串流），或防止下載符合已知惡意軟體模式的檔案。

3. **匿名性與隱私**：

   * 代理防火牆可以**隱藏使用者的IP地址**，讓外部伺服器無法直接看到用戶的真實IP。
   * 這對於**安全瀏覽**尤其有用，可以隱藏身份或避免被追蹤。

4. **隔離作用**：

   * 代理防火牆位於內部網路與外部網路之間，能**隔離內部網路**免於直接暴露於互聯網，防止客戶端與伺服器直接通訊，提供額外保護層。


#### **代理防火牆的類型：**

1. **正向代理（Forward Proxy）**：

   * 最常見的代理防火牆形式，代表客戶端或內部網路代為發送請求到目標伺服器。它還可以快取內容以提升效能，並阻擋惡意網站的訪問。

2. **反向代理（Reverse Proxy）**：

   * 反向代理代表伺服器或網路服務，處理來自外部用戶的請求，並將其轉發給適當的內部伺服器。這種代理能提供負載平衡、網頁加速，以及隱藏內部伺服器結構等安全功能。

## 進階功能
* **流量過濾：**

  * 防火牆根據一套規則來決定是否允許資料進出網路，規則可能依據：

    * IP地址
    * 連接埠
    * **協定**（例如HTTP、FTP）
    * **內容**（根據關鍵字或已知威脅過濾）

* **有狀態與無狀態防火牆：**

  * **有狀態防火牆**會追蹤連線的狀態，能分辨有效回應與非請求流量。
  * **無狀態防火牆**不追蹤連線狀態，僅根據預設規則允許或封鎖資料封包。

* **入侵預防與偵測：**

  * 部分防火牆具備額外功能，可以偵測可疑活動或阻止入侵（例如分散式阻斷服務攻擊，DDoS）。

---

## 什麼事防毒軟體
大多數現代防毒軟體會在背景持續運作，隨時掃描裝置上的新檔案或行為，防止惡意軟體感染發生。 防毒軟體會掃描檔案、應用程式及下載內容是否有可疑行為。如果發現惡意軟體，能夠：

  * **隔離**該檔案（將其與系統其他部分隔離）
  * **刪除**惡意軟體
  * **修復**檔案（如果可能的話）  

### **惡意軟體偵測：**

  * **基於特徵碼的偵測（Signature-based Detection）**：軟體利用已知惡意軟體特徵碼（獨特的資料模式）資料庫來識別病毒。這種方法對已知威脅有效，但無法偵測新出現、未知的惡意軟體。
  模式匹配 檢查目標檔案是否根事先登錄的惡以軟體
行為偵測 機器學習 根據軟體通常會有的行為模式來判斷是不是惡意軟體

  * **基於啟發式的偵測（Heuristic-based Detection）**：防毒程式運用啟發式（規則系統）來判斷潛在有害的行為或程式碼模式，即使該惡意軟體之前未被發現過。
  
  * **基於行為的偵測（Behavioral-based Detection）**：監控異常或可疑活動（例如程式嘗試存取大量記憶體或透過網路傳送資料），以即時辨識惡意軟體。
  自我繁殖 擅自移除 編輯電腦內其他檔案

---

### **1. Sandbox (in Anti-Virus Context)**
動態啟發是掃描

沙箱（sandbox）是一種**安全機制**，用來在受控環境中隔離並測試可疑檔案、程式或行為，防止它們對系統其他部分造成傷害。在**防毒軟體**的範疇中，沙箱技術是將檔案或軟體放在一個安全、隔離的空間（稱為「沙箱」）中執行，讓它們無法影響實際系統或網路。

* **整合於偵測機制中**：沙箱常被作為防毒軟體的一部分，用於在受控環境中**分析檔案**。它並非總是獨立功能，而是一種用於**即時惡意軟體分析**的先進技術。你可以將沙箱技術放在防毒軟體的「惡意軟體偵測」或「進階偵測方法」部分介紹。
#### **沙箱如何運作：**

* **隔離運行**：可疑檔案（例如新下載的軟體、電子郵件附件或未知執行檔）會在虛擬環境中執行。
* **行為監控**：沙箱會監測該檔案的行為，例如是否試圖修改系統檔案、傳送資料到外部伺服器或存取其他應用程式。任何惡意活動都會被立即標記。
* **不會損害主系統**：由於檔案運行於受控環境，即使是惡意程式也無法傷害裝置。若檔案無害，通過測試後即可允許在主系統上執行。

#### **Benefits in Anti-Virus:**

* **Detection of Unknown Malware**: Sandboxing helps detect malware that doesn't have known signatures (i.e., zero-day threats). Even if the anti-virus software doesn't recognize the file, the sandbox can detect malicious behavior.
* **Safe Testing of Files**: Suspicious files can be safely analyzed without risking the device's integrity.

1. **Sandboxing with Virtual Machines**:

   * "Modern sandboxes often use **virtual machines (VMs)** to simulate an isolated environment. VMs allow security systems to run potentially harmful software in a controlled, virtualized environment, where its behavior can be monitored and analyzed without risking the host system."

2. **Isolation and Monitoring**:

   * "VMs play a key role in sandboxing by ensuring that malware cannot escape into the host operating system. The virtualized environment is isolated from the real system, and if anything goes wrong, the snapshot feature of the VM allows for **easy restoration** to a clean state."

3. **VM Evasion**:

   * "However, while VMs provide excellent isolation, some sophisticated malware is designed to **detect virtual environments** and avoid executing harmful actions when it detects that it’s running inside a VM. This presents a challenge for traditional sandboxing techniques that rely on VM-based isolation."

4. **Advancements in Virtual Machine Sandbox Solutions**:

   * "To combat evasion techniques, modern sandboxing solutions are incorporating advanced **hypervisor-level** isolation, which offers additional protection and makes it more difficult for malware to escape the sandboxed environment."

---

### **2. 蜜罐技術（在防毒軟體中的應用）**

**蜜罐（honeypot）**是一種**誘餌系統**或網路，設計用來吸引並監控網路攻擊。它模擬一個看似脆弱的目標，讓攻擊者嘗試利用，藉此讓防禦者觀察攻擊者的戰術、技術和程序（TTPs）。蜜罐通常用於較進階的安全架構中，用以收集情報和研究攻擊模式，但在防毒和更廣泛的惡意軟體偵測策略中也扮演一定角色。

* **作為輔助技術**：蜜罐通常不會直接整合於防毒軟體中，但可作為更廣泛**網路防禦策略**的一部分。如果你想在防毒部分提及蜜罐，可以將它們描述為一種**輔助工具**，用來早期偵測威脅並提供情報，以改進惡意軟體資料庫。可歸類於**威脅情報**或**行為分析**相關內容。

#### **蜜罐的運作方式：**

* **誘捕攻擊者**：蜜罐呈現為看似弱點多、易受攻擊的系統（例如過時軟體、開放埠口等），以**吸引網路犯罪分子。**一旦攻擊者接觸蜜罐，系統會記錄其行動。
* **資料收集**：蜜罐會蒐集有價值的資料，例如攻擊者的IP地址、利用漏洞的手法，以及他們嘗試部署的惡意軟體類型。
* **防止擴散**：當攻擊者專注於誘餌系統時，有助於**防止其攻擊真實且重要的網路資產。**

#### **在防毒軟體中的好處：**

* **威脅情報**：蜜罐收集的資料能幫助提升防毒軟體的偵測能力，提供有關新攻擊手法、惡意軟體變種或新興威脅的洞察，這些威脅可能先前未被發現。
* **早期警示**：蜜罐可作為早期警告系統，在威脅完全在網路或裝置上展現之前就識別出來。


---

## 原罪

### 防火牆
 安全模型從主機推動到邊界
有些組織僅在入口
端點電腦防護幾乎0

防火牆允與許的流量 可以含攻擊
向全球自訊網基本允許，但網頁伺服器基本上都會有弱點
畢竟 通常允許全球資訊網的流量 而這些流量中就可能存在著攻擊

### 防毒
新弱點病毒 才更新特徵值 而不是解決弱點

防毒 使 惡意軟體演化得更為精巧

模式匹配  千面人引勤 變種找步道

行為偵測 偵測不到 什麼叫怪異行為? 

大量偽陽性 導致使用者習慣略
而且真正有問題的反而沒有任何警示

### 沙河
sandbox 跳出
### **How Malware Can Escape a Sandbox:**

1. **Exploiting Vulnerabilities in the Sandbox**:

   * Just like any software, sandbox environments can have **security vulnerabilities**. These weaknesses might be exploited by malware to gain access to the underlying host system.

   * For example, if a sandbox uses certain **shared resources** or is based on an OS or virtualization platform with known vulnerabilities, the malware could **exploit those vulnerabilities** to escape the isolated environment.

   * **Example**: A sandbox might rely on virtualization software (like VMware or VirtualBox), which could have a vulnerability that allows the malware to **break out** from the virtual machine and execute commands on the host system.

2. **Manipulating Shared Resources**:

   * Sandboxes typically simulate an environment with shared resources like disk space, memory, or networking. Malware can sometimes find a way to manipulate these shared resources to escape the sandbox and spread to the host system.
   * **Example**: Malware might find ways to exploit **shared file systems** or **network interfaces** that the sandbox is using to communicate with the host system. By exploiting these shared interfaces, it can push malicious payloads outside the sandbox to the actual system.

3. **Leveraging Kernel Exploits**:

   * In some cases, advanced malware might attempt to break free from a sandbox by exploiting vulnerabilities in the **kernel** of the operating system that is hosting the virtual machine or sandbox. This is a **privilege escalation** attack where the malware moves from the isolated user space into the core part of the OS.
   * **Example**: The malware could attempt to manipulate the sandbox’s **privileged kernel mode** to gain access to the host machine’s kernel and execute commands outside the sandbox.

4. **Direct Memory Access (DMA) Attacks**:

   * In certain configurations, especially in virtual environments, malware might be able to use **DMA** (Direct Memory Access) to **access the physical memory** of the host system. This could allow the malware to bypass the sandbox’s controls and **execute on the host machine**.
   * **Example**: Some malware can try to interact with the **hardware layer** to access memory regions that are shared between the sandbox and the host OS, enabling it to escape the virtualized isolation.

5. **Hypervisor/Virtual Machine Escape**:

   * A **hypervisor** is responsible for managing virtual machines (VMs) in sandbox environments. Some sophisticated malware can target vulnerabilities in the hypervisor itself. If successful, this type of attack can allow malware to **escape the virtual machine** and gain control of the host system.
   * **Example**: If the hypervisor isn’t properly secured, the malware could exploit a flaw to break out of the virtual environment, making it possible to affect not just the sandbox but also the actual system hosting it.

6. **Infecting Other VMs in a Multi-VM Setup**:

   * If a **sandboxing system** runs multiple **virtual machines** on a single host (for testing different behaviors or scenarios), malware could potentially spread across VMs if **network isolation** isn’t properly implemented.
   * **Example**: In a situation where multiple VMs are running on a shared system, malware could potentially infect other VMs on the same host if the isolation mechanisms are weak or misconfigured.

---

### **Why It Happens:**

* **Improper Configuration**: Sandboxes often rely on virtual machines or containers to isolate suspicious processes. If these virtual machines or containers are not configured with strong security controls (e.g., network isolation, resource limits), malware may find ways to bypass those defenses.
* **Zero-Day Exploits**: Some malware are designed to **exploit vulnerabilities** in the sandbox itself—vulnerabilities that might not yet have been discovered or patched. These exploits are often **zero-day**, meaning there’s no prior knowledge of the flaw.
* **Advanced Threat Actors**: More sophisticated cybercriminals or **nation-state actors** often design malware with the intention of evading detection, including sandbox evasion. Their malware might be intentionally crafted to **look benign** when in a sandbox but have the capability to **break out** and fully infect the system when it’s on a real, unprotected machine.

---

### **Real-World Examples of Sandbox Escape:**

1. **CVE-2019-5588 (VMware Escape)**:

   * This vulnerability allowed malware to break out of a **VMware** virtual machine by exploiting flaws in the **vmx** process. Malware running in a virtual machine could execute code on the host system, leading to **host system compromise**.
   * This kind of escape technique highlights the risk of running outdated or unpatched virtual environments.

2. **CVE-2018-5803 (Hyper-V Escape)**:

   * In 2018, a vulnerability was discovered in **Microsoft’s Hyper-V hypervisor** that could allow malware running inside a virtual machine to **escape** and run on the underlying host system. This kind of vulnerability would have serious consequences for sandbox systems running on top of Hyper-V.

3. **Poweliks Trojan**:

   * The **Poweliks Trojan** was a particularly stealthy piece of malware that was able to **evade detection** by analyzing the behavior of the system. It could detect whether it was running in a virtualized environment and **avoid executing** if it was running inside a sandbox. However, if it escaped the sandbox, it could proceed to infect the host machine.
# 【16】資安的原罪 ch.3-2.c 中間人攻擊

「想像一下，你正在登入網路銀行應用程式，仔細輸入使用者名稱和密碼，並以為自己正在安全地存取帳戶。但你不知道的是，有一個駭客正悄悄攔截你的認證資訊，監視你的一舉一動，甚至更改交易細節。這就是中間人攻擊（Man-in-the-Middle，MITM）的危險——當今資安環境中最隱蔽且危害巨大的威脅之一。」

---

### **什麼是中間人攻擊？**

中間人攻擊（Man-in-the-Middle，MITM），有時也稱為 **中間敵手攻擊（Adversary in the Middle，AITM） 是指**攻擊者位於資料流的「中間」**，通常雙方都不會察覺，使攻擊者能夠竊聽、竊取資訊、注入惡意資料，或冒充其中一方。

### **合法中間人**

* **網際網路服務提供商（ISP）**：能夠攔截未加密的流量、進行監控，甚至修改內容。如果在未經你知情或同意的情況下這麼做，可能會引發隱私疑慮。

* **VPN 業者**：若 VPN 服務商能存取你的加密資料或紀錄日誌，他們就可能被視為一種**受信任的中間人**——也就是他們能解密並查看你的流量。因此，選擇可信賴的 VPN 供應商非常重要，以避免隱私受到侵犯。

* **網路管理員（例如學校或公司）**：儘管他們可能出於安全或政策執行的正當理由監控與檢查流量，但他們實際上也處於**通訊過程的中間位置**，理論上可以在使用者不知情的情況下進行監聽或資料操作。

---

### **4. 技術手法：中間人攻擊是如何運作的？**

* **ARP 欺騙（ARP Spoofing / Address Resolution Protocol Spoofing）**

  * 攻擊者在區域網路中發送偽造的 ARP 封包，將自己的**MAC 位址**綁定到受害者的 IP 位址。這樣一來，原本發給受害者的資料就會被轉送到攻擊者手中，進而實現攔截。

* **偽造 DHCP 伺服器攻擊（Rogue DHCP Server Attack）**

  * 攻擊者架設一個**假的 DHCP 伺服器**，並發送惡意網路設定（例如偽造的閘道器或 DNS 伺服器），藉此將受害者的流量引導到自己身上，達到中間人位置。

* **DNS 欺騙 / 快取污染（DNS Spoofing / Cache Poisoning）**

  * 攻擊者**污染 DNS 快取資料，植入錯誤的 DNS 紀錄**，使受害者被導向假的網站。攻擊者可藉此竊取登入憑證或植入惡意程式。

* **Wi-Fi 竊聽 / 邪惡雙胞胎攻擊（Evil Twin Attack）**

  * 攻擊者建立一個偽造的 Wi-Fi 熱點，**名稱與外觀與合法網路幾乎相同**。一旦受害者連接上這個假熱點，他們的所有網路流量就會被攻擊者攔截、查看，甚至修改。

* **SSL 降級攻擊（SSL Stripping）**

  * 攻擊者將原本安全的 HTTPS 連線降級為不安全的 HTTP，藉此移除加密保護。這讓攻擊者可以查看、修改或插入惡意內容進入通訊中。

* **會話劫持（Session Hijacking）**

  * 攻擊者竊取合法的會話 Cookie，進而冒充受害者登入系統，而無需知道密碼。這通常透過 MITM 攻擊來攔截受害者登入時傳送的會話憑證。


TODO: REAL EXAMPLE
B292 New york times
## DNS
「Hazy Hawk」利用DNS錯誤配置劫持知名機構網域[^1]

“HTTPS can be stripped” — also accurate in the sense of SSL/TLS stripping attacks or misconfigurations that downgrade or bypass protections. Explain the concept and show how defenses (HSTS, modern TLS, certificate validation) stop it. Avoid step‑by‑step attack instructions.

---

### 瀏覽器中間人攻擊（MITB，Man-in-the-Browser）

**1. Definition & Core Idea**

MITB 攻擊是指攻擊者透過惡意軟體或瀏覽器外掛，在使用者本地端的瀏覽器中注入惡意程式碼，通常在資料被**加密或送出之前就下手**，即使是使用 HTTPS 也可能被攻擊。對使用者與網頁應用程式來說，這種攻擊幾乎**無法察覺**。

* Banking trojans (e.g., Zeus, SpyEye, Dyre)
* Zeus (2007–2015): Intercepted bank logins, injected extra fields.
* Dridex, Emotet: Delivered via email, hijacked browsers to steal financial info.
* RedLine stealer, modern crypto wallet stealers: Grabbing session tokens.

> MITM（中間人攻擊）主要針對**使用者與伺服器之間的網路通訊**，攻擊者會攔截或竄改傳輸中的資料，對網路層造成威脅；而MITB（瀏覽器中間人攻擊）則直接**入侵使用者的瀏覽器環境**，繞過網路層的安全防護，對使用者端造成更深入且難以察覺的威脅。


### 常見實作手法（概念性，不提供攻擊細節）
 惡意程式會以能夠讀取或修改瀏覽器內容的方式運作
例如：注入程式碼到瀏覽器進程、掛鉤瀏覽器 API、或作為惡意外掛運行。
* TODO: 
* DLL injection (on Windows)
* Browser memory tampering
* 惡意瀏覽器外掛 / 擴充功能：以合法外掛身份安裝但內含惡意邏輯。
* 注入 JavaScript 到頁面（或在 DOM 層掛鉤）：動態修改表單或中斷提交流程。 TODO: DOM injection, JavaScript modification
* 在作業系統層面注入/掛鉤瀏覽器程序（例如透過惡意程式碼模組）以監控與攔截流量。
* 使用「WebInject」類型技術：根據目標網站自動匹配並改寫輸入/提交資料。

**MITB vs. MITM: Key Differences**

| Feature            | MITM                                         | MITB                               |
| ------------------ | -------------------------------------------- | ---------------------------------- |
| Target             | Network communication                        | Browser process                    |
| Location           | External (on network)                        | Internal (on infected device)      |
| Requires access to | Network or router                            | Browser or OS                      |
| Visibility to user | Rare, sometimes visible (e.g. cert warnings) | Completely invisible               |
| Bypasses HTTPS     | No                                           | Yes                                |

---


TODO:  SNARF?
## 竊聽
除了，也有當純竊聽的

### 2. 竊聽（Eavesdropping）在MITM中的角色

* 竊聽是被動攔截訊息的行為，是MITM的基礎或第一步
* 竊聽後，攻擊者可能進一步篡改或偽造訊息，完成MITM

### 3. 典型的竊聽場景

* **WiFi**

  * 公共熱點易遭假熱點、ARP spoofing攻擊
  * 攻擊者可在無加密或弱加密環境中竊聽
* **Bluetooth**

  * 配對過程中若缺乏強認證，易被竊聽或中間人攻擊
  * 攻擊例子：KNOB攻擊、BlueBorne
* 其他：有線網路、手機短信（SMS）等

### 4. MITM攻擊的風險

* 敏感資料外洩（密碼、信用卡號）
* 身份盜用與偽造
* 會話劫持與控制權奪取

### 5. 防範措施

* **加密通訊**（HTTPS/TLS、Bluetooth加密）
* **身份認證**（避免假熱點、設備驗證）
* **使用安全網路環境**（避免使用公共未加密WiFi）
* **更新韌體與軟體**（防止已知漏洞被利用）

### 6. 總結

* MITM是多層次的攻擊，竊聽是其重要環節
* **無線通訊環境（WiFi、Bluetooth）特別容易受影響**

#### 🔹 **Bluetooth MITM (e.g., during pairing)**:

* Vulnerable during **initial pairing** if security is weak (e.g., no authentication or static PINs).
* Attackers can **impersonate** a trusted device or intercept data (like in a keyboard or headphone connection).
* Known attacks:

  * **KNOB attack** (Key Negotiation of Bluetooth): Downgrades encryption strength.
  * **BlueBorne**, **BtleJack**, etc.

#### 🔹 **SMS MITM**:

* SMS is often used for **2FA** (two-factor authentication), and attackers can:

  * Exploit **SS7 protocol vulnerabilities** (used by telecom networks) to intercept SMS.
  TODO:
  * Use **SIM swapping** or **number porting** to reroute SMS to themselves.
* MITM in SMS can allow attackers to hijack accounts that rely on SMS verification.

TODO:
There are several examples of malware targeting cookies from web browsers on the local system. Adversaries may also steal cookies by injecting malicious JavaScript content into websites or relying on User Execution by tricking victims into running malicious JavaScript in their browser.

There are also open source frameworks such as Evilginx2 and Muraena that can gather session cookies through a malicious proxy (e.g., Adversary-in-the-Middle) that can be set up by an adversary and used in phishing campaigns.

After an adversary acquires a valid cookie, they can then perform a Web Session Cookie technique to login to the corresponding web application.[^2]



---

## 原罪

## 難發現
MITM attacks are a serious security threat because they are difficult to detect and can have wide-ranging consequence


## Signs of MITM (unexpected certificate warnings, slow connection, unusual network behavior)

Monitoring tools and network anomaly detection

### 手不需要伸進裝置
不留痕跡

### 無法


* No visible changes to network traffic.
* Antivirus often fails to detect polymorphic malware.
* Legitimate-looking browser behavior (unless you inspect DOM or form data)

### Why a “quiet” MITM is hard to detect

If the attacker only passively sniffed traffic (e.g., captured packets on an unencrypted Wi‑Fi) and didn’t alter messages, there may be no visible protocol anomalies. Encrypted sessions (TLS) protect content, so passive capture leaves little footprint on the network beyond the capture itself.

If the attacker intercepts and relays (transparent MITM) but preserves TLS correctly (e.g., compromises a client or a CA, or performs a proxy with valid certs on the client), traffic looks normal to endpoints.

Short-lived or low-volume MITMs may not show up in logs, and many default logging levels don’t capture the small anomalies an attacker relies on.


[^1]: https://www.informationsecurity.com.tw/article/article_detail.aspx?aid=11907
[^2]: https://attack.mitre.org/techniques/T1539/
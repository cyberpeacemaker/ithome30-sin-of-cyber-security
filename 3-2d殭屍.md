# 【17】資安的原罪 ch.3-2.d 殭屍網路

What if your device was part of a cybercrime ring… and you didn’t know
Did you know that your computer could be attacking others right now—and you wouldn’t even know it?

---

## 什麼是殭屍網路（Botnet）？
殭屍網路是一個由被入侵設備（稱為「殭屍」或「機器人」）組成的網路，這些設備通常在設備擁有者不知情的情況下，被攻擊者（稱為「殭屍網路主控者」或「殭屍主」）遠端控制。

**常見用途**

* **DDoS attacks (Distributed Denial of Service)** — 耗盡可用頻寬、網路連結、記憶體、儲存空間或 CPU 等資源，讓合法使用者無法存取服務；伺服器忙於回應大量虛假請求而癱瘓。
* **Credential stuffing & brute-force attacks** — 利用大量已洩露的帳密組合自動嘗試登入（credential stuffing）或用暴力猜密碼（brute-force），以取得未授權存取。
* **Spam and phishing email distribution（反應爐郵寄者 Reactor Mailer）** — 大量散發垃圾郵件或釣魚郵件，誘騙收件人點擊惡意連結、下載附件或洩露機密資訊；有時會用特定工具（如所稱之 Reactor Mailer）自動化發送。
* **Click fraud / ad fraud** — 人為或機器人偽造點擊廣告或流量，導致廣告主支付無效點擊費用並扭曲廣告成效數據。
* **Cryptocurrency mining (cryptojacking)** — 在受害設備上暗中執行挖礦軟體，消耗 CPU/GPU 資源以挖掘加密貨幣，導致裝置變慢、耗電與硬體壽命縮短。
* **Proxying traffic to hide attacker identity** — 將攻擊流量轉發或代理出去以隱藏真實來源，讓追蹤和阻斷攻擊者變得更加困難。
* **Spreading additional malware or ransomware** — 利用已入侵的設備散布更多惡意軟體或勒索程式，擴大感染範圍或加密受害者資料以索取贖金。
* **Data theft (Log keystrokes, steal passwords or banking info.)** — 竊取鍵盤紀錄、密碼、銀行與個人資料等敏感資訊，用於身份盜用、詐騙或販售於地下市場。
* **Selling access: Botnets as a service (BaaS) on the dark web.** — 攻擊者把已控制的設備或整個 botnet 當作服務出售或租借，他人可付費發動攻擊或執行惡意任務。
TODO:
* **流量** —（看起來是提醒詞）指的是由 botnet 產生的大量網路流量，可用於癱瘓服務、隱匿攻擊來源或造成計量型費用暴增。
* **Adversarial attacks Some botnets are designed to exploit software vulnerabilities or to assist in ransomware campaigns.** — 某些 botnet 專門用來掃描並利用軟體漏洞取得更深層控制，或作為協助勒索軟體攻擊的工具（例如用來散播勒索載荷或阻斷救援通道）。

### 基本組成部分：

* 殭屍網路主控者／控制者：控制殭屍網路的人或組織。
* 指揮與控制（C2）基礎設施：殭屍接收指令的機制。
* 殭屍／機器人：被感染的設備（包括個人電腦、物聯網裝置、伺服器、行動裝置等）。
## Payload, Beacon & C2

* **Payload** = the malware binary/module that executes on the victim (what does the malware *do*?).
* **Beacon** = the periodic network “call home” the infected host makes to check for instructions (how the payload *contacts* the controller).
* **C2 (Command & Control)** = the infrastructure the attacker uses to receive beacons and issue commands (where the payload gets orders and updates).

Think: *payload runs → beacon calls C2 → C2 replies with commands or additional payloads → payload executes commands or fetches more modules.*

### 2. **How Botnets Work**

* **Step-by-step process**:
1. 攻擊者製作或購買惡意程式（malware / payload）。
2. 惡意程式藉由釣魚郵件、惡意下載或瀏覽器即時攻擊（drive-by）散播並初次攻陷目標。
3. 投放器（dropper）將payload寫入磁碟，建立持久性（persistence）。
4. payload 啟動回報程式（beacon），定期聯絡控制端（C2，如透過 HTTPS POST 到某個域名）。
5. 控制端回傳指令（例如下載額外模組、執行命令、設定外洩路徑）。
6. payload 按指令執行（偵察／recon、帳密竊取、側向移動等），並可能分階段部署其他惡意軟體（例如之後再放勒索軟體）。

## Payload（有效負載）介紹 — 繁體中文簡明說明

**Payload（有效負載）**指攻擊者放到被害系統上、實際執行惡意目的的程式碼／模組。它是入侵鏈中「做事」的那一段：蒐集資料、建立後門、下載其他模組、橫向移動或部署勒索軟體等。下面把常見類型、`staged` vs `stageless` 概念、實務考量、偵測與防護一次說清楚。

### Payload 的常見類型（高階分法）

* **Dropper / Installer（投放程式）**：把其他惡意檔案寫入磁碟並建立持久性。通常本身不做太多動作，只負責安裝。
* **Downloader / Fetcher（下載器）**：連回 C2 下載主 payload（stage）。
* **Implant / Backdoor（植入體 / 後門）**：常駐記憶體或系統，接收遠端指令或開放通道。
* **Beacon / Beaconing 模組**：負責與 C2 聯絡，回報狀態並領取指令。
* **Module（模組）**：特定功能（credential theft、keylogger、ransomware payload、DDoS 模組 等）。
* **Loader / Shellcode**：較低階，用於把記憶體內的 code 執行起來（例如 exploit 後注入的 shellcode）。

### Staged vs Stageless（分階段與無階段）核心概念

**Staged（分階段）**

* **定義**：初期 payload（稱為 stage0，例如 dropper 或 downloader）很小，執行後再從 C2 或遠端位置下載更大的主要 payload（stage1、stage2 ...）。
* **優點**：初始檔案較小、較難被靜態簽名比對攔截；攻擊者可動態選擇/更新後續模組；分階段可延遲風暴式活動降低早期偵測機會。
* **缺點**：下載階段會產生網路行為（易留下痕跡）；若 C2 被封鎖或註冊域名失效，後續階段失敗。
* **常見場景**：利用 downloader 下載 Meterpreter、Cobalt Strike 之類的 payload（示意用途）。

**Stageless（無階段 / 單體）**

* **定義**：初始投入的 payload 本身就是完整的惡意程式，不再向外下載主要功能；一個檔案（或記憶體塊）即完成所有功能。
* **優點**：執行時不需再聯網下載大量程式，減少外部網路足跡；對抗 C2 封鎖更有彈性（本體已具備功能）。
* **缺點**：初始檔案通常較大，容易被靜態分析或簽名偵測到；缺乏攻擊者在執行時動態更換 payload 的便利。
* **常見場景**：一次性植入的勒索軟體樣本、純記憶體攻擊的單檔 implant（在記憶體執行且不再取下一步）。

## 什麼是 beacon？

**Beacon** 指被感染主機定期向其 C2 發出的網路聯絡，用來：

* 檢查是否有新指令，
* 傳送狀態／元資料，
* 小規模外洩資料，
* 下載或取得額外模組。

### Beacon 的行為特性

* **間隔（Interval）**：固定（例如每 60 秒）或隨機化以避開偵測。有些實作使用指數退避。
* **beacon 的負載（Payload）**：通常為小型 JSON、Base64 二進位塊、加密資料，或編碼於 DNS 子網域標籤中。
* **抖動（Jitter）**：在時間上做小幅變化以避免以簽名為基礎的偵測。
* **睡眠模式（Sleep modes）**：長時間休眠後突發活動。
* **回呼模式（Callback patterns）**：重試次數、使用多個備援網域或 IP 的策略。


# 2) C2（指揮與控制）

代理中繼伺服器 proxy relay 中段伺服器 middle server
The attacker’s own communications out of their infrastructure will likely be anonymized — that is, bounced through a series of proxy servers to hide their true identity

As mentioned above, a beacon or payload is an executable or program that communicates back to the attacker via some communication channel. This may be **secured over HTTPS** or use a **plain-text protocol such as DNS**.
TODO: SMB PIVOT, , 

## 架構

* **集中式（經典）**：單一 C2 伺服器或小型伺服器群（HTTP/HTTPS、IRC、自訂 TCP）。簡單但有單點故障風險。
* **點對點（P2P）**：感染主機形成網狀結構；指令在節點間傳播（較難一舉鏟除）。
* **去中心化 / 濫用雲端服務**：利用雲端服務、社交平台、公開 API 或第三方託管。
* **Fast‑flux / 網域輪換**：頻繁變更 DNS 紀錄以隱藏 C2 的實體 IP。
* **網域產生演算法（DGA）**：惡意程式計算大量網域名稱並嘗試連線；攻擊者只註冊其中部分。
* **隱寫／隱蔽通道**：透過 DNS TXT、ICMP、Tor 或社交平台等方式傳遞 C2 指令；將命令藏在看似無害的流量中。

## 常見協定與技術

* **HTTP/S（GET/POST）** — 與正常網頁流量混合。可能使用 TLS。
* **DNS 查詢**（利用 TXT 或子網域標籤來外洩資料）。
* **自訂 TCP/UDP 協定、IRC**。
* **使用合法憑證／CDN 的 HTTPS** 來混淆流量來源。
* **電子郵件、雲端儲存（如 S3、Dropbox）** 作為非同步 C2 通道。

**DNScat2**
One important part of this infrastructure is the Domain Name System (DNS). An attacker can leverage DNS to deliver malicious communications to their infrastructure, and they can also use DNS to exfiltrate (that is, steal) data.

## shell code
An exploit is often separate from the beacon or payload. However, the two are commonly put together as shellcode

Once the exploit gains access to the target system, it will load a small beacon or payload that can call back to the attacker to complete the attack, a process known as payload staging.

#### Botkit
bootkit 感染主啟動紀錄MBR進行持久畫

## lateral movement
As shown below, they can also upload Mimikatz, a malicious tool for stealing user credentials. Attackers need credentials with elevated privileges to perform system-level actions and lateral movement inside a network.

## Persistence mechanisms

* Registry Run keys (Windows), systemd timers/services (Linux), cron jobs, startup folders, firmware-level persistence for advanced threats.

Another critical step for the attacker is creating a **route back to the victim machine, even after it has been rebooted by the user**. This is where the technique of persistence comes into play. Attackers have several ways to achieve this, including autorun reverse payloads and persistent backdoors.

As shown below, the attacker chooses to run a post-exploit persistence module, which involves a Visual Basic Script (VBScript) placed in the Windows Temp folder of the logged-on user, UoPfNwo.vbs. The attacker then installs a Windows registry entry to enable the script to autorun after the machine boots up.

### Evasion techniques used by botnets
#### memory-only
memory-only dropper
polymorphic bots
## Packing, obfuscation, and evasions

* Packers, crypters, and polymorphism to avoid static detection.
* Use of living-off-the-land binaries (LOLBins) to run code via signed system tools.
* In-memory execution (fileless) to avoid disk artifacts.

#### rootkit
一套可以遠端控制主機的後們程式(backdoor)或木馬程式(trojan)
隱藏
最高權限root

Now the attacker has ensured that their payload script can connect back to their listener, even if the machine is rebooted. However, files on the disk can now also be detected by a file system antivirus (AV) scan.

Finally, the attacker will want to clean up all potential evidence. To do this, they may remove original malicious files and entries, and encrypt or even mix malicious files among legitimate system files. To further cover their tracks, they can also delete both shadow copies and system logs.

The ability to start **new processes** is very useful. The attacker can start a new unsuspecting process like notepad.exe and then **migrate their original malicious payload process to it using code / DLL injection**. It’s a technique that makes a malicious process on the system appear to be legitimate

---

# example
Netcurs 900萬台[^1]
mirai便寵 drake dingle chickenmelon 70萬系統 100GB/s流量
值得關注的是，殭屍網路攻擊從感染裝置到完全清除的平均時長，在2023年上半年攀升至近1.5個月，是5年前的1000倍以上，這也意味著殭屍網路對受感染企業的影響時間將大幅拉長，可能造成更加龐大的資安風險與營運損失。[^9]
* 🕷️ **Mirai**: Famous IoT botnet that took down major websites (Netflix, Twitter) via DNS provider Dyn in 2016.
* 🦠 **Emotet**: Started as banking malware, evolved into a modular botnet for spam and malware distribution.
* 👾 **Zeus/Zbot**: Banking trojan with MITB features, often used in botnets.
* ⚠️ **QakBot**: Multifunction botnet used for ransomware delivery before its takedown in 2023.

* **Mirai Botnet**: Brought down major websites like Twitter, Netflix via DDoS in 2016
* **Zeus/Zbot**: Banking Trojan used for credential theft
* **Emotet**: Once one of the most dangerous botnets for spam and malware delivery

--- 

## 原罪

### 6.通訊塞車

顛峰時段塞車正常。但無法阻止有人隨意控制成群車子製造塞車

### 責任轉移
殭屍電腦的元兇。但責任卻轉移到要普通民眾不成為殭屍，困難

### 公地悲劇
他人收到垃圾郵件或遭到阻斷服務於，自己無關，

### 
DDOS 正常現象 是現象被濫用
預防DDOS 提升運算資源 浪費過多資源成本
DDoS殭屍網路普遍鎖定Linux、物聯網裝置[^6]

## 連線通訊機制

- TCP機制 SYN洪水
- UDP洪水攻擊


### **3. Infection & Propagation Vectors**

* **Phishing emails** (with trojans)
* **Drive-by downloads**
* **Exploiting unpatched software or open ports**
* **Malicious browser extensions or cracked software**
* **IoT devices with default credentials or no firmware updates**

[^1]: https://www.cic.police.ntpc.gov.tw/cp-755-73423-28.html
[^6]: https://www.ithome.com.tw/news/169020
[^2]: https://www.bleepingcomputer.com/news/security/ddos-defender-targeted-in-15-bpps-denial-of-service-attack/